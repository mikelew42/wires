var TestFramework = require("../test/framework");
var test = TestFramework.test;
var assert = console.assert.bind(console);
var is = require("../is");
var $ = require("jquery");
var View = require("./View");
var Div = require("./Div");

// require("./even-more.less");

var logger = require("log42");
var log = logger();

var xtest = function(){};

$(function(){

var SimplePager = View.extend({
	name: "SimplePager",
	addClass: "simple-pager",
	init: function(){
		this.chain = [];
	},
	content: function(){
		this.append(this.name);
	},
	to: function(view){
		view.hide();
		view.appendTo(this.$el);

		// store the last page
		if (this.last)
			this.chain.push(this.last);

		if (this.current){
			this.current.hide();
			this.last = this.current;
		}
		
		view.show();
		this.current = view;
	},
	back: function(){
		if (this.current)
			this.current.hide();
		
		if (this.last)
			this.last.show();

		this.current = this.last;
		this.last = this.chain.pop();
	}
});

var Flex = View.AutoSub.extend({
	css: {
		display: "flex"
	},
	Left: View.AutoSub.extend(),
	Right: View.AutoSub.extend(),
	content: function(){
		this.left.render();
		this.right.render();
	}
});

test("SimplePager", function(){

	var pager = SimplePager({
		name: "pager",
		autoRender: false,
		css: {
			border: "2px solid black",
			height: "100%"
		},
		a: View(function(){
			this.append("a");
		}),
		b: View(function(){
			this.append("b")
		})
	});


	for (var i = 1; i < 11; i++){
		pager["v"+i] = View(function(){
			this.append("v"+i);
			View({
				tag: "button",
				content: "back",
				click: [function(){
					pager.back();
				}]
			})
		});
	}

	var createButton = function(pager, name){
		View({
			// tag: "button",
			css: { padding: "5px 10px", display: "block", cursor: "pointer", background: "#eee" },
			content: name,
			click: [function(){
				pager.to(pager[name]);
			}]
		});
	};


	Flex({
		left: function(){
			for (var i in pager){
				if (pager[i] instanceof View){
					if (i === "base" || i === "proto")
						continue;
					pager[i].hide();
					createButton(pager, i);
				}
			}
		},
		right: function(){
			this.css("flex-grow", 1);
			pager.render()
		}
	});
});

var Page = View.extend({
	name: "Page",
	autoRender: false,
	addClass: "page",
	css: {
		marginBottom: "1em",
		background: "rgba(0,0,0,0.1)"
	},
	size: 0,
	depth: 1,
	inst: function(){
		this.pages = [];
	},
	content: function(){
		var page = this;

		View({
			tag: "button",
			content: "back",
			click: [function(){
				page.pager.back()
			}]
		})

		View({
			tag: "h3",
			content: this.name
		});

		View(function(){
			this.filler("3s");
		});

		if (this.size && this.depth > 0){
			View({
				addClass: "children",
				css: {
					padding: "10px"
				},
				content: function(){
					for (var i = 1; i <= page.size; i++){
						Page({
							name: page.name + "-" + i,
							pager: page.pager,
							size: page.size,
							depth: page.depth - 1
						}).hide().render().button()
					}
				}
			})
		}
	},
	out: function(){
		this.removeClass("in").addClass("out").hide();
	},
	in: function(){
		this.addClass("in").removeClass("out").show();
	},
	button: function(){
		var page = this;
		View(function(){
			this.append(page.name);
			this.css({
				padding: "6px 12px",
				cursor: "pointer"
			});
			this.click(function(){
				console.log("click");
				page.activate();
			})
		})
	},
	activate: function(){
		this.pager.to(this);
	},
	set_pager: function(pager){
		this.pager = pager;
	},
	addPage: function(page){
		if (!(page instanceof Page)){
			page = Page(page);
		}

		this.pages.push(page);
		page.set_pager(this.pager);
		return page;
	},
	make: function(number, depth){
		var name, page;
		for (var i = 1; i < number; i++){
			name = "";
			if (this.parent)
				name = this.parent.name + "-";
			name += i;
			page = this.addPage({
				name: name,
				parent: this
			});

			if (depth)
				page.make(number, depth - 1);
		}
	}
});

test("Pages", function(){
	SimplePager(function(){
		this.to(Page({
			name: "test",
			pager: this,
			size: 5,
			depth: 5
		}).render());
	})
});

});