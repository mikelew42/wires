var TestFramework = require("test/framework");
var test = TestFramework.test;
var is = require("is");
var $ = require("jquery");
var assert = console.assert.bind(console);

var app = require("app");
var Mod = require("mod42");
var Mod1 = require("mod42/Mod1");
var Mod2 = require("mod42/Mod2");
var Mod3 = require("mod42/Mod3");
var Mod4 = require("mod42/Mod4");
var Mod5 = require("mod42/Mod5");
var Mod6 = require("mod42/Mod6");

$(function(){

test("mod42", function(){
	test("basic", function(){
		var mod = Mod();
		assert(mod instanceof Mod);
		assert(mod.constructor === Mod);
	});

	test("instantiate overriding", function(){
		var mod = Mod({
			instantiate: function(){
				// should not run... instantiate cannot be overridden per instance
				assert(false);
			}
		});

		var check = {};

		var Mod2 = Mod.extend({
			instantiate: function(){
				check.instantiate = true;
			}
		});

		var mod2 = Mod2();

		assert(check.instantiate === true);
	});

	test("Mod1", function(){

		test("basic", function(){
			var mod = Mod1();
			assert(mod instanceof Mod1);
			assert(mod.constructor === Mod1);
		});

		test("create, assign, init", function(){
			var check = {},
				mod = Mod1({
					init: function(){
						check.init = true;
					}
				});

			assert(check.init);
		});

		test("extend", function(){

			test("one", function(){
				var Mod2 = Mod1.extend();

				assert(Mod2.base === Mod1);

				var mod2 = Mod2();
				assert(mod2 instanceof Mod2);
				assert(mod2 instanceof Mod1);
			});

			test("two", function(){
				var check = {},
					Mod2 = Mod1.extend({
						name: "Mod2",
						prop: 123,
						init: function(){
							check.init = true;
						}
					}, {
						prop: 456
					});

				assert(Mod2.name === "Mod2");
				assert(!check.init);
				assert(Mod2.prototype.prop === 456);

				var mod2 = new Mod2({
					prop: 678
				});

				assert(mod2.name === "mod2");
				assert(check.init);
				assert(mod2.prop === 678);
				assert(mod2.proto.prop === 456);
				assert(!mod2.base.prop);

				var Mod3 = Mod2.extend({
					prop: 789
				});
				var mod3 = new Mod3({
					prop: 234
				});

				assert(mod3.prop === 234);
				assert(mod3.proto.prop === 789);
				assert(mod3.base.prop === 456);
			});

			test("three", function(){
				var check = {},
					Mod2 = Mod1.extend({
						set: {
							main: function(){
								check.set = true;
							}
						}
					});

				assert(!check.set);
				Mod2.prototype.set();
				assert(check.set);
				assert(Mod2.prototype.set !== Mod1.prototype.set);
			});

			test("set", function(){

			});
		});
	});

	test("Mod2", function(){
		var mod = Mod2({
			log: false
		});

		mod.log = true;

		mod.log("hello");
		mod.log.info("info");
		mod.log.debug("debug");
		mod.log.warn("warn");
		mod.log.error("error");
		mod.log.group("group");
		mod.log.log("log.log");
		mod.log.end();

		mod.log = false;
		mod.log.warn("this should not be");
		
		var Mod3 = Mod2.extend();
		var mod3 = Mod3();

		mod3.log("this should be on");

		var Mod4 = Mod2.extend({
			log: false,
			method: function(){
				this.log.error("oh shit");
				this.log = true;
				this.log("ok, we're good");
			}
		});

		var mod4 = Mod4();
		mod4.method();

	});

	test("Mod3", function(){
		var mod = Mod3({
			init: function(){
				this.wrapMe();
			},
			wrapMe: function(){
				this.log("inside wrapMe");
			}
		});

		mod.wrapMe();
	});

	test("Mod4", function(){
		console.warn("must visually inspect this test");
		var mod = Mod4({
			test1: 1,
			test2: true,
			test3: "three",
			test4: function(){
				this.log("hello world");
			}
		});

		mod.test1 = 2;
		mod.test2 = false;
		mod.test3 = "four";
		mod.test4(1, true, "three");
	});

	test("Mod5", function(){
		console.info(Date.now() - app.start_time);

		console.log(Mod5.prototype.set.mfn.id);

		var Settings = Mod5.Settings;
		var settings = Settings();

		var Mod6 = Mod5.extend({
			name: "Mod6",
			settings: settings
		});

		assert(Mod6.prototype.settings === settings);

		var Mod7 = Mod6.extend({
			name: "Mod7",
			settings: {
				one: {
					one1: 1,
					one2: true,
					one3: "three"
				},
				two: {
					two1: 4,
					two2: false,
					two3: "six",
					two4: {
						seven: 8
					}
				}
			}
		});

		assert(Mod7.prototype.settings instanceof Settings);
		assert(Mod7.prototype.settings !== Mod6.prototype.settings);
		assert(Mod7.prototype.settings.one.one1 === 1);
		assert(Mod7.prototype.settings.one.one2 === true);
		assert(Mod7.prototype.settings.two.two4.seven === 8);

		var mod = Mod7({
			settings: {
				one: {
					one2: false
				}
			}
		});

		assert(mod.settings.one.one1 === 1);
		assert(mod.settings.one.one2 === false);
		assert(Mod7.prototype.settings.one.one2 === true);

		// they should only Object.create() themselves when they are modified
		assert(mod.settings.one !== Mod7.prototype.settings.one);
		assert(mod.settings.two === Mod7.prototype.settings.two);

		assert(mod.settings.two.two4.seven === 8);

		var mod2 = Mod7({
			settings: {
				two: {
					two4: {
						nine: 10
					}
				}
			}
		});

		assert(mod2.settings.one.one3 === "three");
		assert(mod2.settings.one === Mod7.prototype.settings.one);
	});

	test("Mod6", function(){
		assert(Mod6.prototype.set.mfn.Method !== Mod5.prototype.set.mfn.Method);
		

		var getter = function(){
			console.log("poop");
			return this.value;
		}
		// .set changes won't take place in time?  I guess it could work, if used in order...
		var mod = Mod6({
			set: {
				Property: {
					init: function(){
						console.log("ppppoooooooppp");
						this.init_define();
					},
					getter: getter
				}
			}
		});

		mod.set({
			test: 2
		});

		assert(Mod6.prototype.set.mfn.Property !== mod.set.mfn.Property);
		assert(mod.set.mfn.Property.prototype.getter === getter);

		mod.test = mod.test + 3;



	});

	test("Mod6-2", function(){
		var Mod7 = Mod6.extend({
			set: {
				Method: {
					something: 123
				}
			},
			settings: {
				methods: {
					testDisabled: {
						disabled: true
					},
					testEnabled: {
						execWrapper: function(ctx, args){
							console.log(this.something);
							return this.logAndExecMethod(ctx, args);
						}
					}
				}
			}
		});

		assert(Mod7.prototype.settings.methods.testDisabled.disabled === true);
		assert(is.fn(Mod7.prototype.settings.methods.testEnabled.execWrapper));

		debugger;
		
		var mod = Mod7({
			init: function(){
				this.testDisabled();
				this.testEnabled();
			},
			testDisabled: function(){
				console.log("should not be wrapped");
			},
			testEnabled: function(){
				console.log("should be preceeded by 123");
			}
		});

		// assert(mod.settings.)
	});
});

});